# Unicodeä¸Žç ç‚¹

## Unicode

ç»Ÿä¸€å­—ç¬¦é›†ï¼ˆUniversal Coded Character Set, UCSï¼‰ï¼Œæ¯ä¸ªå­—ç¬¦æ˜ å°„è‡³ä¸€ä¸ªæ•´æ•°ç ç‚¹ï¼ˆcode pointï¼‰ï¼Œç ç‚¹çš„èŒƒå›´æ˜¯ 0 è‡³ 0x10FFFFï¼Œç ç‚¹åˆé€šå¸¸è®°ä½œ U+XXXXï¼Œå½“ä¸­ XXXX ä¸º 16 è¿›ä½æ•°å­—ã€‚ä¾‹å¦‚ `åŠ²` â†’ U+52B2ã€`å³°` â†’ U+5CF0ã€‚å¾ˆæ˜Žæ˜¾ï¼ŒUCS ä¸­çš„å­—ç¬¦æ— æ³•åƒ ASCII èˆ¬ä»¥ä¸€ä¸ªå­—èŠ‚å­˜å‚¨ã€‚

å› æ­¤ï¼ŒUnicode è¿˜åˆ¶å®šäº†å„ç§å‚¨å­˜ç ç‚¹çš„æ–¹å¼ï¼Œè¿™äº›æ–¹å¼ç§°ä¸º Unicode è½¬æ¢æ ¼å¼ï¼ˆUniform Transformation Format, UTFï¼‰ã€‚çŽ°æ—¶æµè¡Œçš„ UTF ä¸º UTF-8ã€UTF-16 å’Œ UTF-32ã€‚æ¯ç§ UTF ä¼šæŠŠä¸€ä¸ªç ç‚¹å‚¨å­˜ä¸ºä¸€è‡³å¤šä¸ªç¼–ç å•å…ƒï¼ˆcode unitï¼‰ã€‚ä¾‹å¦‚ UTF-8 çš„ç¼–ç å•å…ƒæ˜¯ 8 ä½çš„å­—èŠ‚ã€UTF-16 ä¸º 16 ä½ã€UTF-32 ä¸º 32 ä½ã€‚é™¤ UTF-32 å¤–ï¼ŒUTF-8 å’Œ UTF-16 éƒ½æ˜¯å¯å˜é•¿åº¦ç¼–ç ã€‚

UTF-8 æˆä¸ºçŽ°æ—¶äº’è”ç½‘ä¸Šæœ€æµè¡Œçš„æ ¼å¼ï¼Œæœ‰å‡ ä¸ªåŽŸå› ï¼š

1. å®ƒé‡‡ç”¨å­—èŠ‚ä¸ºç¼–ç å•å…ƒï¼Œä¸ä¼šæœ‰å­—èŠ‚åºï¼ˆendiannessï¼‰çš„é—®é¢˜ã€‚
2. æ¯ä¸ª ASCII å­—ç¬¦åªéœ€ä¸€ä¸ªå­—èŠ‚åŽ»å‚¨å­˜ã€‚
3. å¦‚æžœç¨‹åºåŽŸæ¥æ˜¯ä»¥å­—èŠ‚æ–¹å¼å‚¨å­˜å­—ç¬¦ï¼Œç†è®ºä¸Šä¸éœ€è¦ç‰¹åˆ«æ”¹åŠ¨å°±èƒ½å¤„ç† UTF-8 çš„æ•°æ®ã€‚

## å¦‚ä½•å¤„ç†æ›´å¤šçš„ç ç‚¹

å¯¹äºŽ JSONå­—ç¬¦ä¸²ä¸­çš„ `\uXXXX` æ˜¯ä»¥ 16 è¿›åˆ¶è¡¨ç¤ºç ç‚¹ U+0000 è‡³ U+FFFFï¼Œæˆ‘ä»¬éœ€è¦ï¼š

1. è§£æž 4 ä½åå…­è¿›åˆ¶æ•´æ•°ä¸ºç ç‚¹ï¼›
2. ç”±äºŽå­—ç¬¦ä¸²æ˜¯ä»¥ UTF-8 å­˜å‚¨ï¼Œæˆ‘ä»¬è¦æŠŠè¿™ä¸ªç ç‚¹ç¼–ç æˆ UTF-8ã€‚

åŒå­¦å¯èƒ½ä¼šå‘çŽ°ï¼Œ4 ä½çš„ 16 è¿›åˆ¶æ•°å­—åªèƒ½è¡¨ç¤º 0 è‡³ 0xFFFFï¼Œä½†ä¹‹å‰æˆ‘ä»¬è¯´ UCS çš„ç ç‚¹æ˜¯ä»Ž 0 è‡³ 0x10FFFFï¼Œé‚£æ€Žä¹ˆèƒ½è¡¨ç¤ºå¤šå‡ºæ¥çš„ç ç‚¹ï¼Ÿ

å…¶å®žï¼ŒU+0000 è‡³ U+FFFF è¿™ç»„ Unicode å­—ç¬¦ç§°ä¸ºåŸºæœ¬å¤šæ–‡ç§å¹³é¢ï¼ˆbasic multilingual plane, BMPï¼‰ï¼Œè¿˜æœ‰å¦å¤– 16 ä¸ªå¹³é¢ã€‚é‚£ä¹ˆ BMP ä»¥å¤–çš„å­—ç¬¦ï¼ŒJSON ä¼šä½¿ç”¨ä»£ç†å¯¹ï¼ˆsurrogate pairï¼‰è¡¨ç¤º `\uXXXX\uYYYY`ã€‚åœ¨ BMP ä¸­ï¼Œä¿ç•™äº† 2048 ä¸ªä»£ç†ç ç‚¹ã€‚å¦‚æžœç¬¬ä¸€ä¸ªç ç‚¹æ˜¯ U+D800 è‡³ U+DBFFï¼Œæˆ‘ä»¬ä¾¿çŸ¥é“å®ƒçš„ä»£ç å¯¹çš„é«˜ä»£ç†é¡¹ï¼ˆhigh surrogateï¼‰ï¼Œä¹‹åŽåº”è¯¥ä¼´éšä¸€ä¸ª U+DC00 è‡³ U+DFFF çš„ä½Žä»£ç†é¡¹ï¼ˆlow surrogateï¼‰ã€‚ç„¶åŽï¼Œæˆ‘ä»¬ç”¨ä¸‹åˆ—å…¬å¼æŠŠä»£ç†å¯¹ (H, L) å˜æ¢æˆçœŸå®žçš„ç ç‚¹ï¼š

```Plain
codepoint = 0x10000 + (H âˆ’ 0xD800) Ã— 0x400 + (L âˆ’ 0xDC00)
```

ä¸¾ä¸ªä¾‹å­ï¼Œé«˜éŸ³è°±å·å­—ç¬¦ `ð„ž` â†’ U+1D11E ä¸æ˜¯ BMP ä¹‹å†…çš„å­—ç¬¦ã€‚åœ¨ JSON ä¸­å¯å†™æˆè½¬ä¹‰åºåˆ— `\uD834\uDD1E`ï¼Œæˆ‘ä»¬è§£æžç¬¬ä¸€ä¸ª `\uD834` å¾—åˆ°ç ç‚¹ U+D834ï¼Œæˆ‘ä»¬å‘çŽ°å®ƒæ˜¯ U+D800 è‡³ U+DBFF å†…çš„ç ç‚¹ï¼Œæ‰€ä»¥å®ƒæ˜¯é«˜ä»£ç†é¡¹ã€‚ç„¶åŽæˆ‘ä»¬è§£æžä¸‹ä¸€ä¸ªè½¬ä¹‰åºåˆ— `\uDD1E` å¾—åˆ°ç ç‚¹ U+DD1Eï¼Œå®ƒåœ¨ U+DC00 è‡³ U+DFFF ä¹‹å†…ï¼Œæ˜¯åˆæ³•çš„ä½Žä»£ç†é¡¹ã€‚æˆ‘ä»¬è®¡ç®—å…¶ç ç‚¹ï¼š

```Plain
H = 0xD834, L = 0xDD1E
codepoint = 0x10000 + (H âˆ’ 0xD800) Ã— 0x400 + (L âˆ’ 0xDC00)
          = 0x10000 + (0xD834 - 0xD800) Ã— 0x400 + (0xDD1E âˆ’ 0xDC00)
          = 0x10000 + 0x34 Ã— 0x400 + 0x11E
          = 0x10000 + 0xD000 + 0x11E
          = 0x1D11E
```

è¿™æ ·å°±å¾—å‡ºè¿™è½¬ä¹‰åºåˆ—çš„ç ç‚¹ï¼Œç„¶åŽæˆ‘ä»¬å†æŠŠå®ƒç¼–ç æˆ UTF-8ã€‚

## UTF-8çš„ç¼–ç æ–¹å¼

UTF-8 çš„ç¼–ç å•å…ƒä¸º 8 ä½ï¼ˆ1 å­—èŠ‚ï¼‰ï¼Œæ¯ä¸ªç ç‚¹ç¼–ç æˆ 1 è‡³ 4 ä¸ªå­—èŠ‚ã€‚å®ƒçš„ç¼–ç æ–¹å¼å¾ˆç®€å•ï¼ŒæŒ‰ç…§ç ç‚¹çš„èŒƒå›´ï¼ŒæŠŠç ç‚¹çš„äºŒè¿›ä½åˆ†æ‹†æˆ 1 è‡³æœ€å¤š 4 ä¸ªå­—èŠ‚ï¼š

**ã€æ³¨ã€‘**è¿™é‡Œçš„xxxæ˜¯è¦å¡«å…¥çš„ä½ï¼Œä¾‹å¦‚ç ç‚¹èŒƒå›´U+0800~U+FFFFï¼Œä¹Ÿå°±æ˜¯ä¸‹è¾¹è¡¨æ ¼çš„ç¬¬ä¸‰è¡Œï¼Œå¦‚æžœå¯¹åº”çš„äºŒè¿›åˆ¶æ˜¯0010000010101100ï¼Œå³æŒ‰é¡ºåºï¼Œå¡«å…¥xä¸­ï¼Œå³ï¼šæŒ‰é¡ºåºå¡«å…¥1110xxxx, 10xxxxxx, 10xxxxxxã€‚ å¯¹äºŒè¿›åˆ¶è¿›è¡Œåˆ†ç»„ï¼Œä¾æ¬¡æ’å…¥xä¸­ã€‚ ç¬¬ä¸€ç»„ï¼š0010ï¼Œ ç¬¬äºŒç»„ï¼š000010ï¼Œ ç¬¬ä¸‰ç»„ï¼š101100ï¼Œ æœ€åŽå¾—åˆ°ï¼š11100010, 10000010, 10101100

| ç ç‚¹èŒƒå›´           | ç ç‚¹ä½æ•° | å­—èŠ‚1    | å­—èŠ‚2    | å­—èŠ‚3    | å­—èŠ‚4    |
| ------------------ | -------- | -------- | -------- | -------- | -------- |
| U+0000 ~ U+007F    | 7        | 0xxxxxxx |          |          |          |
| U+0080 ~ U+07FF    | 11       | 110xxxxx | 10xxxxxx |          |          |
| U+0800 ~ U+FFFF    | 16       | 1110xxxx | 10xxxxxx | 10xxxxxx |          |
| U+10000 ~ U+10FFFF | 21       | 11110xxx | 10xxxxxx | 10xxxxxx | 10xxxxxx |

è¿™ä¸ªç¼–ç æ–¹æ³•çš„å¥½å¤„ä¹‹ä¸€æ˜¯ï¼Œç ç‚¹èŒƒå›´ U+0000 ~ U+007F ç¼–ç ä¸ºä¸€ä¸ªå­—èŠ‚ï¼Œä¸Ž ASCII ç¼–ç å…¼å®¹ã€‚è¿™èŒƒå›´çš„ Unicode ç ç‚¹ä¹Ÿæ˜¯å’Œ ASCII å­—ç¬¦ç›¸åŒçš„ã€‚å› æ­¤ï¼Œä¸€ä¸ª ASCII æ–‡æœ¬ä¹Ÿæ˜¯ä¸€ä¸ª UTF-8 æ–‡æœ¬ã€‚

æˆ‘ä»¬ä¸¾ä¸€ä¸ªä¾‹å­è§£æžå¤šå­—èŠ‚çš„æƒ…å†µï¼Œæ¬§å…ƒç¬¦å· `â‚¬` â†’ U+20ACï¼š

1. U+20AC åœ¨ U+0800 ~ U+FFFF çš„èŒƒå›´å†…ï¼Œåº”ç¼–ç æˆ 3 ä¸ªå­—èŠ‚ã€‚
2. U+20AC çš„äºŒè¿›ä½ä¸º 10000010101100
3. 3 ä¸ªå­—èŠ‚çš„æƒ…å†µæˆ‘ä»¬è¦ 16 ä½çš„ç ç‚¹ï¼Œæ‰€ä»¥åœ¨å‰é¢è¡¥ä¸¤ä¸ª 0ï¼Œæˆä¸º 0010000010101100
4. æŒ‰ä¸Šè¡¨æŠŠäºŒè¿›ä½åˆ†æˆ 3 ç»„ï¼š0010, 000010, 101100
5. åŠ ä¸Šæ¯ä¸ªå­—èŠ‚çš„å‰ç¼€ï¼š11100010, 10000010, 10101100
6. ç”¨åå…­è¿›ä½è¡¨ç¤ºå³ï¼š0xE2, 0x82, 0xAC

å¯¹äºŽè¿™ä¾‹å­çš„èŒƒå›´ï¼Œå¯¹åº”çš„ C ä»£ç æ˜¯è¿™æ ·çš„ï¼š

```C
if (u >= 0x0800 && u <= 0xFFFF) {
    OutputByte(0xE0 | ((u >> 12) & 0xFF)); /* 0xE0 = 11100000 */
    OutputByte(0x80 | ((u >>  6) & 0x3F)); /* 0x80 = 10000000 */
    OutputByte(0x80 | ( u        & 0x3F)); /* 0x3F = 00111111 */
}
```